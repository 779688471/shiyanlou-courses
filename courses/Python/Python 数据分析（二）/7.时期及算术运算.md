# 时期及其算术运算
## 一、实验介绍

　　时期（Period）表示的是时间区间，比如数日、数月数季、数年等。Period 类所表示的就是这种数据类型，其构造函数需要用到一个字符串或整数，以及频率：

```
In [100]: p = pd.Period(2012, freq=&#34;A-DEC&#34;)

In [101]: p
Out[101]: Period(&#39;2012&#39;, &#39;A-DEC&#39;)
```
　　这个 Period 对象表示的是从2012年1月1日到2012年12月31日之间的整段时间。只需对 Period 对象加上或减去一个整数即可达根据其频率进行位移的效果：

```
In [102]: p + 5
Out[102]: Period(&#39;2017&#39;, &#39;A-DEC&#39;)

In [103]: p - 2
Out[103]: Period(&#39;2010&#39;, &#39;A-DEC&#39;)
```
　　如果两个 Period 对象拥有相同的频率，则它们的差就是它们之间的单位数量：

```

In [104]: pd.Period(&#39;2014&#39;, freq=&#39;A-DEC&#39;) - p
Out[104]: 2

In [105]: #period_range 函数可用于创建规则的时期范围

In [106]: rng = pd.period_range(&#39;1/1/2015&#39;,&#39;6/30/2015&#39;,freq=&#39;M&#39;) 

In [107]: rng
Out[107]: PeriodIndex([&#39;2015-01&#39;, &#39;2015-02&#39;, &#39;2015-03&#39;, &#39;2015-04&#39;, &#39;2015-05&#39;, &#39;2015-06&#39;], dtype=&#39;int64&#39;, freq=&#39;M&#39;)
```

　　PeriodIndex 类保存了一组 Period，它可以在任何 pandas 数据结构中被用作轴索引：

```
In [108]: Series(np.random.randn(6), index = rng)
Out[108]: 
2015-01    1.058402
2015-02    0.195045
2015-03    1.308358
2015-04    0.052861
2015-05   -1.351775
2015-06    1.445766
Freq: M, dtype: float64

In [109]: #PeriodIndex 类的构造函数还允许直接使用一组字符串

In [110]:  values = [&#39;2001Q3&#39;, &#39;2002Q2&#39;, &#39;2003Q1&#39;]

In [111]: index = pd.PeriodIndex(values, freq=&#39;Q-DEC&#39;)

In [112]: index
Out[112]: PeriodIndex([&#39;2001Q3&#39;, &#39;2002Q2&#39;, &#39;2003Q1&#39;], dtype=&#39;int64&#39;, freq=&#39;Q-DEC&#39;)
```
　　
　　

## 二、时期的频率转换

　　Period 和 PeriodIndex 对象都可以通过其 asfreq 方法被转换成别的频率。假设我们有一个年度时期，希望将其转换为当年年初或年末的一个月度时期：

```
In [113]: p = pd.Period(&#39;2015&#39;, freq = &#39;A-DEC&#39;)

In [114]: p.asfreq(&#39;M&#39;, how = &#39;start&#39;)
Out[114]: Period(&#39;2015-01&#39;, &#39;M&#39;)

In [115]: p.asfreq(&#39;M&#39;,how=&#39;end&#39;)
Out[115]: Period(&#39;2015-12&#39;, &#39;M&#39;)
```

　　我们可以将 Period(&#39;2015&#39;,&#39;A-DEC&#39;)看做一个被划分为多个月度时期的时间段中的游标。对于一个不以12结束的财政年度，月度子时期的归属情况就不一样了：

```
In [116]: p = pd.Period(&#39;2015&#39;, freq = &#39;A-JUN&#39;)

In [117]: p.asfreq(&#39;M&#39;, &#39;start&#39;)
Out[117]: Period(&#39;2014-07&#39;, &#39;M&#39;)

In [118]: p.asfreq(&#39;M&#39;,&#39;end&#39;)
Out[118]: Period(&#39;2015-06&#39;, &#39;M&#39;)
```

　　在将高频率转换为低频率时，超时期（superperiod）是由子时期（subperiod）所属的位置决定的。例如，在 A-JUN 频率中，月份“2014年8月”实际上是属于周期“2015年”的：

```
In [119]: p = pd.Period(&#39;2014-08&#39;,&#39;M&#39;)

In [120]: p.asfreq(&#39;A-JUN&#39;)
Out[120]: Period(&#39;2015&#39;, &#39;A-JUN&#39;)

In [121]: #PeriodIndex 或 TimeSeries 的频率转换方式也是如此

In [122]: rng = pd.period_range(&#39;2010&#39;,&#39;2015&#39;,freq=&#39;A-DEC&#39;)

In [123]: ts = Series(np.random.randn(len(rng)),index=rng)

In [124]: ts
Out[124]: 
2010   -2.306315
2011   -2.493315
2012   -0.571840
2013    0.219989
2014    0.588717
2015    1.436950
Freq: A-DEC, dtype: float64

In [125]: ts.asfreq(&#39;M&#39;,how=&#39;start&#39;)
Out[125]: 
2010-01   -2.306315
2011-01   -2.493315
2012-01   -0.571840
2013-01    0.219989
2014-01    0.588717
2015-01    1.436950
Freq: M, dtype: float64

In [126]: ts.asfreq(&#39;B&#39;,how=&#39;end&#39;)
Out[126]: 
2010-12-31   -2.306315
2011-12-30   -2.493315
2012-12-31   -0.571840
2013-12-31    0.219989
2014-12-31    0.588717
2015-12-31    1.436950
Freq: B, dtype: float64


```


## 三、

　　季度型数据在会计、金融等领域中很常见。许多季度型数据都会涉及“财年末”的概念，通常是一年12个月中某月的最后一个日历日或工作日。就这一点来说，时期“2012Q4”根据财年末的不同会有不同的含义。pandas 支持12种可能的季度型频率，即 Q-JAN 到 Q-DEC：

```
In [128]: p = pd.Period(&#39;2012Q4&#39;, freq=&#39;Q-JAN&#39;)

In [129]: p
Out[129]: Period(&#39;2012Q4&#39;, &#39;Q-JAN&#39;)
```

　　在以1月结束的财年中，2012Q4是从11月到1月（将其转换为日型频率就明白了）

```
In [130]: p.asfreq(&#39;D&#39;,&#39;start&#39;)
Out[130]: Period(&#39;2011-11-01&#39;, &#39;D&#39;)

In [131]: p.asfreq(&#39;D&#39;,&#39;end&#39;)
Out[131]: Period(&#39;2012-01-31&#39;, &#39;D&#39;)
```

　　因此，Period 之间的算术运算会非常简单。例如，要获取该季度倒数第二个工作日下午4点的时间戳，我们可以这样：

```
In [132]: p4pm = (p.asfreq(&#39;B&#39;,&#39;e&#39;)-1).asfreq(&#39;T&#39;,&#39;s&#39;)+16*60

In [133]: p4pm
Out[133]: Period(&#39;2012-01-30 16:00&#39;, &#39;T&#39;)

In [134]: p4pm.to_timestamp()
Out[134]: Timestamp(&#39;2012-01-30 16:00:00&#39;)
```

　　period_range 还可以用于生成季度型范围。季度型范围的算术运算也跟上面是一样的：
```
In [140]: rng = pd.period_range(&#39;2014Q3&#39;,&#39;2015Q4&#39;,freq=&#39;Q-JAN&#39;) 

In [141]: ts = Series(np.arange(len(rng)), index = rng)

In [142]: ts
Out[142]: 
2014Q3    0
2014Q4    1
2015Q1    2
2015Q2    3
2015Q3    4
2015Q4    5
Freq: Q-JAN, dtype: int64

In [143]: new_rng = (rng.asfreq(&#39;B&#39;,&#39;e&#39;)-1).asfreq(&#39;T&#39;,&#39;s&#39;)+16*60 

In [144]: ts.index = new_rng.to_timestamp()

In [145]: ts
Out[145]: 
2013-10-30 16:00:00    0
2014-01-30 16:00:00    1
2014-04-29 16:00:00    2
2014-07-30 16:00:00    3
2014-10-30 16:00:00    4
2015-01-29 16:00:00    5
dtype: int64


```
## 四、将 Timestamp 转换为 Period（及其反向过程）

　　通过使用 to_period 方法，可以将由时间戳索引的 Series 和 DataFrame 对象转换为以时期索引：

```
In [146]: rng = pd.date_range(&#39;1/1/2000&#39;,periods=3,freq=&#39;M&#39;)

In [147]: ts = Series(randn(3),index=rng)

In [148]: pts=ts.to_period()

In [149]: ts
Out[149]: 
2000-01-31   -0.957822
2000-02-29    0.715783
2000-03-31   -0.005190
Freq: M, dtype: float64

In [150]: pts
Out[150]: 
2000-01   -0.957822
2000-02    0.715783
2000-03   -0.005190
Freq: M, dtype: float64


```
　　由于时期指的是非重叠时间区间，因此对于给定的频率，一个时间戳只能属于一个时期。新 PeriodIndex 的频率默认是从时间戳推断而来的，你也可以指定任何别的频率。结果中允许存在重复时期：

```
In [151]: rng = pd.date_range(&#39;1/29/2000&#39;,periods=6,freq=&#39;D&#39;)

In [152]: ts2 = Series(randn(6), index=rng)

In [153]: ts2.to_period(&#39;M&#39;)
Out[153]: 
2000-01    0.239469
2000-01    0.482394
2000-01    1.096005
2000-02    0.547852
2000-02   -1.032463
2000-02   -1.246191
Freq: M, dtype: float64

In [154]: #要转换为时间戳，使用 to_timestamp 即可

In [155]:  pts = ts.to_period()

In [156]: pts
Out[156]: 
2000-01   -0.957822
2000-02    0.715783
2000-03   -0.005190
Freq: M, dtype: float64

In [157]: pts.to_timestamp(how=&#39;end&#39;)
Out[157]: 
2000-01-31   -0.957822
2000-02-29    0.715783
2000-03-31   -0.005190
Freq: M, dtype: float64


```

## 五、通过数组创建 PerioIndex

　　固定频率的数据集通常会将时间信息分开存放在多个列中。例如，在下面这个宏观经济数据集中，年度和季度就分别存放在不同的列中：

```
In [169]: data = pd.read_csv(&#39;macrodata.csv&#39;) 
In [170]: data.year
Out[170]: 
0      1959
1      1959
2      1959
3      1959
       ... 
199    2008
200    2009
201    2009
202    2009
Name: year, dtype: float64

In [171]: data.quarter
Out[171]: 
0      1
1      2
2      3
3      4
     ...
199    4
200    1
201    2
202    3
Name: quarter, dtype: float64
```
　　将这两个数组以一个频率传入 PeriodIndex，就可以将它们合并成 DataFrame 的一个索引：

```
In [172]: index = pd.PeriodIndex(year = data.year,
   .....:                        quarter = data.quarter, 
   .....:                        freq = &#39;Q-DEC&#39;)

In [173]: index
Out[173]: 
PeriodIndex([&#39;1959Q1&#39;, &#39;1959Q2&#39;, &#39;1959Q3&#39;, &#39;1959Q4&#39;, &#39;1960Q1&#39;, &#39;1960Q2&#39;,
             &#39;1960Q3&#39;, &#39;1960Q4&#39;, &#39;1961Q1&#39;, &#39;1961Q2&#39;, 
             ...
             &#39;2007Q2&#39;, &#39;2007Q3&#39;, &#39;2007Q4&#39;, &#39;2008Q1&#39;, &#39;2008Q2&#39;, &#39;2008Q3&#39;,
             &#39;2008Q4&#39;, &#39;2009Q1&#39;, &#39;2009Q2&#39;, &#39;2009Q3&#39;],
            dtype=&#39;int64&#39;, length=203, freq=&#39;Q-DEC&#39;)

In [174]: data.index = index

In [175]: data.infl
Out[175]: 
1959Q1    0.00
1959Q2    2.34
1959Q3    2.74
1959Q4    0.27
          ... 
2008Q4   -8.79
2009Q1    0.94
2009Q2    3.37
2009Q3    3.56
Freq: Q-DEC, Name: infl, dtype: float64
```

## 六、作业

　　好了，同学们今天的内容就到这里。希望同学们下来的时候好好理解一下 asfreq 的用法，把上面的内容好好消化一下，然后自己在 Ipython 的环境下，训练训练。