# 关于搞活商业街的调查问卷，这东西该怎么做

![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.001.png)

> 本书以一种特别的方式，将知识融入到故事，读者可以在一个个事件的发生中去领略数据分析的魅力
>
> 故事以一个小商业街为舞台，主人公田中俵太是文科的大学应届毕业生。他自今年春天入职征信所，职务是 “侦探”。他将在天羽幸小姐的指导下从零开始学习数据分析。天羽小姐是数据分析专家，为人略显霸道，加之其人生字典里从来没有“委婉” 二字，让我们的主人公俵太三天两头就要受点打击。每到这种时候，天羽小姐的助手川崎逸子小姐就会站出来，将数据分析的入门知识手把手地传授给俵太。

## 一、实验介绍

### 1.1 实验内容

故事背景：自俵太入职以来已经半月有余，商业街会长樱田先生再次敲响了 AMO'S 事务所的大门。因为前阵子附近车站进行改造一事，导致商业街的顾客减少，因此樱田先生打算和天羽小姐商量一个搞活商业街的项目。樱田先生认为给商业街弄一个吉祥物做做宣传，并制作了一个调查表征求众人意见。就让我们一起跟着天羽小姐的统计学一起来搞定这个调查问卷吧!

### 1.2 课程来源

本课程基于 [图灵社区](http://www.ituring.com.cn/) 的 [《菜鸟侦探挑战数据分析》](http://www.ituring.com.cn/book/1809) 第 3 章制作，感谢 [图灵社区](http://www.ituring.com.cn/) 授权实验楼发布。如需系统的学习本书，请购买[《菜鸟侦探挑战数据分析》](http://www.ituring.com.cn/book/1809)。

为了保证可以在实验楼环境中完成本次实验，我们在原书内容基础上补充了一系列的实验指导，比如实验截图，代码注释，帮助您更好得实战。

如果您对于实验有疑惑或者建议可以随时在讨论区中提问，与同学们一起探讨。

### 1.3 实验知识点

- 数据的录入方式
- 列联表
- 独立性检验（卡方检验）及其方法
- 列联表的图

### 1.4 实验环境

- R version 3.4.1
- Xfce 终端

### 1.5 适合人群

本课程难度为简单，属于初级级别课程，对于没有 R 语言基础的同学也很友好。

### 1.6 代码及数据的获取

读者可以下载本章的代码和数据，用自己喜欢的编辑器阅读。

请输入以下代码获取数据和代码：

```
wget http://labfile.oss.aliyuncs.com/courses/873/code03.tar.gz

```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323264528.png/wm)

## 二、实验内容

** 由于本实验是以案件为线索，因此文字量比较多，读者可以跟随文中人物的步伐进行全新的实验体验 ^o^**

### 2.1 传统吉祥物还是萌系美少女?

自我入职以来已经半月有余，这天早晨，商业街会长樱田先生再次敲响了 AMO'S 事务所的大门。天羽小姐、逸子小姐和我一同来到接待室招呼樱田先生。

“其实，我最近在琢磨一个搞活商业街的项目，所以想跟天羽小姐商量商量。”

“客流果然受影响了？”

天羽小姐口中说的 “影响”，八成是前阵子附近车站进行改造一事。樱田先生的商业街连接着出站检票口和住宅区，所以街上大部分人都是回家路上顺便逛一逛。经过这次改造，车站新开了一条通道，可以从车站内直达车站百货商场，乘客出检票口后可以直接经由车站商场回家。一旦人们习惯了这条路线，来商业街买东西的顾客势必会减少。前几天听逸子小姐讲，以樱田先生为首的商业街店主们最近正在为这件事发愁。貌似车站改造后重新开放是 3 月初的事，那么算起来距今已经有一个多月了。

“呃，这个我还没具体调查，到时候估计还得请你帮忙。不过今天我来是为了别的事儿。”

樱田先生把用绳子捆好的厚厚一叠 A4 纸放到了桌子上。

“这是什么？”

天羽小姐解开绳子，拿起最上面的一张纸。我从旁边瞟了瞟纸面，貌似是问卷调查。纸上印着一些问题，问题旁边还有手写的回答。

“是这样，我觉得给商业街弄个吉祥物做做宣传或许会有帮助。你想啊，最近不是挺流行那种可爱的圆滚滚的吉祥物吗？我就是想搞个那玩意。结果一帮年轻的店主们说用新兴的萌系角色比较好。”

“萌系角色？动漫美少女那种吗？”

“俵太看来很感兴趣嘛。”

逸子小姐笑着对我说道。

“不…… 不是，我对那个没什么兴趣，但这类吉祥物貌似很有效果的。之前有部以几个爱好登山的女孩子为主角的动画，背景是埼玉县某市。结果那里成了粉丝们眼中的圣地，吸引了好多喜欢这部动画的人去朝圣。”

见我慌忙开口否定，逸子小姐笑得更开心了。

“这都行？我是理解不了。”

天羽小姐一脸无奈。

“不，确实是田中说的那样，听说这吉祥物对城市宣传挺有作用的。当然我也无法理解就是了。后来说到传统型的吉祥物和萌系吉祥物该用哪个的时候，我本来打算让商业街内部投票表决，但他们认为既然要征求众人意见，不如直接搞个问卷调查听听顾客怎么说。”

### 2.2　调查问卷

“所以你就搞了个问卷调查，然后把填好的问卷都扔到我这来了？”

天羽小姐竖起了眉毛。

“不好意思，就是这么回事。因为我实在不知道该怎么办了。”

“既然迟早都要拿到我这儿来，那你做问卷调查前至少该跟我商量一下吧？”

说着，天羽小姐把手中的问卷往桌上一扔，气愤地靠在了沙发上。调查问卷在桌边散落了一地。我一边动手收拾，一边问樱田先生。

“这个问卷是调查什么的啊？”

“主要是问问对方更喜欢萌系吉祥物还是传统吉祥物。后来觉得反正都做调查了，不如多加几个问题。”

“你多加几个没用的问题是觉得自己赚了，但这次调查的正题怎么办？这闹不好就分析不出来了！”

仰靠在沙发上的天羽小姐句句带刺，看来心情糟糕透了。

“好啦好啦，阿幸，先看看再说嘛。”

逸子小姐站出来当和事佬了。我也趁这个机会仔细看了看问卷。

- **商业街调查问卷的开头部分**

  ![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.002.png)

“先是选择性别、年龄、职业。然后是 4 个问题，对吧。”

“这问题太烂了。”

天羽小姐戳了戳桌上那叠问卷的最上面一张。

“诶？哪个？”

樱田先生满脸惊讶。

“问题 4，‘您经常光顾本商业街吗？’这一项。我给你举个例子。俵太，这道题你会怎么答？”

“诶？我吗？我每天早晨和晚上都要穿过商业街，所以该选‘是’吧？”

“不对，田中，这道题是在问‘是否经常来商业街买东西’。”

“啊，这个意思吗？那，我每周会在商业街买几次盒饭，或者在那儿吃午饭，这样算不算‘经常光顾’啊？”

“好了，你瞧吧。”

天羽小姐的语气中带着嘲讽。

![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.003.png)

“问题里的‘经常’缺乏一个具体标准，几次才算经常？另外，像俵太这样把单纯路过商业街也算作‘光顾’的大有人在。”

樱田先生纠结地双手抱头，看来这事儿挺让他头疼的。结果天羽小姐非但没就此罢口，反而又补了一刀。

“这种情况下，应该问‘您平均 1 周来商业街购物几次？’才对，而且要把回答设置成‘几乎每天’‘1 周 2 ～ 3 次’‘1 周 1 次’‘其他’这种形式。还有，下面这个‘今后还会光顾本商业街吗？’也是多余。填这问卷的都是来商业街购物的顾客吧？除非人家有极其特殊的情况，否则谁也不会选‘否’。”

“你的意思是，这调查问卷白费功夫了？这下惨了，亏我还回收了将近 100 张……”

“这个‘您觉得本商业街的魅力在哪里？’或许能用。”

- **勉强能用的项目**

  ![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.004.png)

“我懂了，是调查顾客们的潜在需求吧？”

樱田先生的表情缓和了些。

“差不多。但你当初为什么不多加几个选项，做成多选形式的呢？”

“话是这么说，但大伙儿出主意的时候又是‘店铺的风格’又是‘价格’，一个个都是想到啥说啥，没完没了。最后我只好自作主张总结成了 4 个。”

“无所谓了，反正这问卷调查都做过了，现在说什么也是白费。话说，让商业街的店主们也答答这问卷如何？”

“诶？这个嘛，其实已经让他们试着答过了。”

樱田先生打开放在地上的包，从里面又取出了一叠纸。天羽小姐把整叠纸接过，快速翻看了起来。

“唔。店主们和顾客们的回答可能会不太一样。”

“你是说，店主们觉得自己的商业街是这个样，但顾客们实际感受到的商业街是那个样，两边的印象错位了？”

我伸长脖子，努力想看清店主们的答卷。

“差不多吧。俵太，把这个输进制表软件。”

“Excel 吗？”

“我说‘制表软件’你没听见？”

天羽小姐低着头，眉间竖起了可怕的川字纹。见我吓得像小鸡一样，坐在对面的逸子小姐一如既往，咯咯地笑了起来。

## 三、实验步骤

### 3.1 输入调查问卷的数据

这会儿樱田先生已经离开，天羽小姐也不知道去了哪里。我走回办公室，‘咣’地一声把堆成山的问卷撂在桌上，按下电脑电源，打开 Excel。刚要开工，逸子小姐端了杯茶送到我手边。

“啊，谢谢。话说，天羽小姐人也是真好，居然义务帮别人做这种工作。”

“不是义务的哦。”

“诶？但从头到尾都没谈钱啊？”

“咱公司呀，是商业街的顾问侦探。”

我听说过顾问律师，但顾问侦探这词儿还是头一次听说。本打算问问这里和商业街究竟是怎样一个关系，结果逸子小姐先开了口。

“俵太，输入数据不用我再教了吧？”

“呃，我应该没问题。行是答题者，列是回答的内容对吧？”

“嗯嗯。”

“所以，输成这样对吗？”

我从桌上拿了 2 张问卷输进了电脑。

**表 3-1　问卷数据的输入**

| 编号   | 性别   | 年龄        | 职业   | 回答 6  | 回答 7  |
| ---- | ---- | --------- | ---- | ----- | ----- |
| 1    | 男    | 50 ～ 59 岁 | 公司职员 | 服务态度好 | 传统吉祥物 |
| 2    | 女    | 40 ～ 49 岁 | 主妇   | 促销    | 传统吉祥物 |

“嗯。然后还需要再添一列，用来存放区分店主还是顾客。列名嘛，可以先叫**立场**之类的，里面的数据写**顾客**或者**店家**。嫌麻烦的话直接用 1 和 0 也行。”

“诶？ 1 和 0 吗？”

“因为足够区分了呀。只要事先定好 1 是顾客 0 是店家就行。这类数据称作二元变量，或者叫伪变量。”

“这些我还是第一次听说。”

**表 3-2　添加列**

| 编号   | 性别   | 年龄        | 职业   | 回答 6  | 回答 7  | 立场   |
| ---- | ---- | --------- | ---- | ----- | ----- | ---- |
| 1    | 男    | 50 ～ 59 岁 | 公司职员 | 服务态度好 | 传统吉祥物 | 顾客   |
| 2    | 女    | 40 ～ 49 岁 | 主妇   | 促销    | 传统吉祥物 | 顾客   |

逸子小姐笑了笑，把椅子推回了自己的位置。

“输一会儿歇一会儿就好，别太勉强自己，太累了只会更容易输错东西。”

这句话我倒是认同，但毕竟还不到中午，加把劲儿的话，应该能赶在下班前录完。更何况我也没有其他事可干。回想起来，从入职到现在我还一次班都没加过。每天一到 5 点，天羽小姐就会跟我说 “可以下班了”。可每次听到这句，我心里第一反应总是“今天什么活儿都没干，就这么下班真的好吗？” 但接下来逸子小姐一定会笑着说一句 “辛苦啦”。然而话又说回来，她们两个从来不在这个时间下班。我曾试探着问过：“二位还不回家吗？” 得到的回答是：“我们还有事没办完。”

我一言不发地埋头敲着键盘。偶尔遇到回答栏留空的情况，我问了问逸子小姐，她表示可以直接留空，或者记上 “无回答”，要么就直接输入个 NA。NA 好像是 not available（无可用回答）的缩写。然后她还不忘补上一句 “输入方法可以根据自己的习惯来，但一定要保证前后统一”。

搞定近 200 张问卷的录入工作，我揉了揉发干的眼睛。这时，逸子小姐关心地说：“累了吧，辛苦你啦，可以下班了哟。” 我抬头看了看墙上的时钟，还不到 5 点。正在犹豫之际，逸子小姐微笑着从挂衣架上取下我的外套递了过来。既然如此，我只好恭敬不如从命，起身踏上了回家的路。

*在这里我们代替俵太把数据上传到了实验平台上，读者可根据下面指令获取*

```
tar -zxvf code03.tar.gz

```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323310096.png/wm)

*因为 R 的版本问题，我们在进行实验之前需要转换一下‘survey.csv’这个文件的编码。我们使用 iconv 工具来对文件的编码进行转换。*

```
iconv -f GBK -t UTF-8 code03/survey.csv -o code03/survey1.csv

```

其中的参数的意义表示

> -f From 某个编码
>
> -t To 某个编码
>
> -o 输出到文件

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323340092.png/wm)

## 3.2　将数据制成列联表

第二天来到公司，发现天羽小姐居然破天荒地在等我。她见面第一句话便是询问昨天的数据如何了。

“昨天我就录入完了，随时可以给您。”

“那好，咱们来简单地分析一下这次问卷调查，顺便也指导下你。”

天羽小姐指了指我的桌子，看来是要用我的电脑。她把自己的椅子拉到我桌边坐了下来。我紧张兮兮地打开制表软件，加载文件。这时候，后脑勺冷不丁地被天羽小姐一敲。

“用了之前教你的录入格式啊，学得挺快嘛。”

我脸上一阵热，瞟了一眼正准备外出的逸子小姐。她冲我挤了挤眼，悄悄伸出手来竖起大拇指，随即转身出门去了。

“接下来，咱们看看商业街的店主们跟顾客们是否有意见分歧。你先把这些数据转换成列联表。”

“列联表？”

“嗯。这种表你见过的吧？”

天羽小姐扯过一张打印过东西的废纸，动笔画了一个表格。

**表 3-3　天羽小姐的手绘表格**

| 您支持 A 候选人吗 | 男    | 女    |
| ---------- | ---- | ---- |
| 支持         | 8    | 5    |
| 不支持        | 5    | 7    |

“这表示的是分别调查了男性和女性对 A 候选人的支持情况吧？数字是人数。”

“没错。这类表就叫作**列联表**。不过，它只是对已输入数据的一种统计。统计前的数据要以这种格式输入制表软件。”

天羽小姐在废纸上继续画着。

**表 3-4　天羽小姐的手绘表格 2**

| 编号   | 性别   | 回答   |
| ---- | ---- | ---- |
| 1    | 女性   | 支持   |
| 2    | 男性   | 不支持  |
| 3    | 男性   | 支持   |
| …    | …    | …    |
| 23   | 男性   | 不支持  |
| 24   | 男性   | 不支持  |
| 25   | 女性   | 不支持  |

“先要有这些已经输入在制表软件中的数据，然后才能制作列联表。”

“好麻烦啊。直接先按性别和回答给这些问卷分类，然后再数一数不就好了？感觉这样比录入还快一些。”

听了我的疑问，天羽小姐犀利的目光透过镜片径直向我刺来。

“数错了怎么办？单留个统计结果，以后想验证都没法验证吧？再说了，分析问卷结果又不是光用列联表就行的。”

我在一旁点头如捣蒜，拼命表达着 “您说的对”。

“共享盘里有这类型的示例数据，你自己加载一下看看。”

“啥？”

“急死我了。这么弄！”

天羽小姐蛮横地拽过电脑，在键盘上敲了一阵，随后将屏幕转向我。

进入 R 环境：

```
    sudo R

```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499324672024.png/wm)

```
> dat <- read.csv("sample.csv") # 输入dat<- read.csv(file.choose())则可以通过对话框指定sample.cs

> dat

```

　

```
    SEX RES
1    F   Y
2    F   N
3    M   Y
4    F   N
   ⋮
   ⋮
23   M   N
24   M   Y
25   M   Y
26   F   N



```

“这是啥？”

“不就是我刚才写在纸上的吗？”

说着她把那张废纸塞到我面前。

“您把数据内容换成英语了？太抽象了看不太懂。F 是 Female 的缩写？”

“只是把**性别**换成了 SEX，**回答**换成了 RES 而已。然后 F 是女性 Female，M 是男性 Man。Y 是 Yes，N 是 No。”

“直接用中文不就好了？”

“输入起来太麻烦了。中文还要处理汉字的问题，但英文和数字就没那么多事儿。行了，咱们言归正传。现在这个名为 `dat` 的数据已经加载进了 RStudio，我们来根据它生成列联表。”

“很复杂吧？”

“这个倒是不复杂。”

天羽小姐麻利地敲了几下键盘。

```
> table (dat)



```

　

```
   RES
SEX N Y
  F 8 6
  M 5 7



```

“啊？这就完了？”

“对。英文中的表就是 table，所以在 R 里，生成表的函数叫 `table()`。”

“突然觉得很没技术含量。”

“别自信得太早。你等一下。”

天羽小姐再次夺过键盘。

*由于本实验环境下的 R 版本较高，所以在导入‘dplyr’包之前，需要先导入‘tidyverse’包*

```
> install.packages ("tidyverse")
> library(tidyverse)

```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323442264.png/wm)

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323537884.png/wm)

*‘dplyr’包安装的时间会有点长，请耐心等待~*

```
> install.packages ("dplyr")



```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323482334.png/wm)

“这是在干什么？”

“给 RStudio 安装额外功能。好了。”

她看都没看我一眼，继续敲着代码。

```
> library (dplyr)



```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323503182.png/wm)

```
> dat %>% table



```

　

```
   RES
SEX N Y
  F 8 6
  M 5 7



```

“呃，您稍微等一下。这个跟刚才的 `table(dat)` 一样？”

“嗯，这是最近比较流行的方法，叫**管道处理**。你可以把它理解成用 `%>%` 符号让左边的数据流到右边。”

“右边？”

“这里的 `table` 函数虽然去掉了圆括号，但它制表的功能没有变。这条命令的意思就是**用左边的数据生成表**。`%>%` 称作管道运算符。刚才我们生成了男女两方支持 A 候选人的人数的列联表，现在给它起个名叫 `dat2` 保存起来。”

```
> dat2 <- dat %>% table
> dat2



```

　

```
   RES
SEX N Y
  F 8 6
  M 5 7



```

## 3.3　独立性检验

“接下来对这个 `dat2` 进行**独立性检验**。”

“又冒出一个听着就很难的词啊。”

“这个检验的原理确实很复杂，但实际操作并不难。只要输这么一条命令就行。”

```
chisq.test(dat2)



```

天羽小姐输完命令一敲 Enter，屏幕上立刻显示出了结果。

```
> chisq.test (dat2)



```

　

```
    Pearson's Chi-squared test with Yates' continuity correction

data: dat2
X-squared = 0.15476, df = 1, p-value = 0.694



```

“或者可以用刚才讲的管道运算符。像这样……”

```
> dat2 %>% chisq.test



```

屏幕上这堆东西我能猜到是检验结果，然而根本看不懂。

“翻译过来大概是这样。”

见我桌上有张包装纸，天羽小姐便顺手扯了过来，在背面写了如下内容。

```
> 卡方检验 (dat2)



```

　

```
    皮尔逊卡方检验，已进行叶氏连续性修正

数据名: dat2
卡方值 = 0.15476, 自由度 = 1, 概率 = 0.694



```

“我来讲一下，首先 `chisq.test()` 是进行独立性检验的函数。这种检验也叫**卡方检验**。”

“卡？”

“就是希腊字母卡（*χ*）。”

“又是希腊文吗？”

“确实是希腊文，怎么了？”

“不不，没怎么。您…… 您继续讲。”

天羽小姐一脸莫名其妙地歪了歪头，随后继续刚才的话题。

“统计学以**卡方值**为基准判断列联表中的数值是否存在偏差。”

“表中存在偏差是什么意思？”

“对这张列联表而言，就是指‘男女对 A 候选人的支持率是否不同’。从这次输出的结果来看，由于卡方值很小，可以认为表中不存在偏差。在 RStudio 的这堆输出里，`X-squared` 的数值意味着表的偏差程度，术语称作**卡方统计量**。现在这个值是 0.15476，而出现这么大偏差的概率为 `p-value=0.694`。通过数据分析进行检验时，我们以‘这个概率到不到 5%’为判断基准。如果不足 5%，就认为它存在显著偏差。”

“存在显著偏差？”

“就是指出现这种偏差绝非偶然。至于这张列联表，检测结果已经证明它的偏差只是偶然罢了。也就是说男女的回答基本相同。”

“跟前阵子的**均值差异检验**一个思路啊。”

“以 5% 为显著水平这点确实一样，但卡方检验主要用于分析列联表。嗯？你写什么呢？”

“没什么，我怕把刚才讲的方法忘了，所以记个笔记。”

天羽小姐微微斜过身子，端详着我摊开在桌上的笔记本。

- **俵太整理的笔记：问卷数据的分析**

  ![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.005.png)

## 3.4　独立性检验的意义

“这类统计‘有多少人’或者‘有多少个’的数据叫频率数据。对这种数据进行检验时，要先把它们制成列联表。不过俵太，你记笔记我不反对，但这种东西还得靠实践。动脑不如动手。去给你昨天录入的数据做个检验。”

说着，天羽小姐把电脑挪到了我面前。

“从加载数据开始。”

我一时慌了手脚，脑袋里只有一个 “诶” 字。但冷静下来转念一想，用 RStudio 加载数据的方法逸子小姐已经教过我很多次了。我昨天准备好的文件是 CSV 格式，所以要选能读取这个格式的函数，也就是 `read.csv`。然后在函数的圆括号里填上文件名 `survey.csv`。

```
read.csv ("code03/survey1.csv")



```

或者用 `file.choose()` 代替文件名，从对话框里选择对应文件。另外，由于必须让 R 记住这个文件的内容，所以要给数据起个名字。名字可以随便起，这里我直接沿袭了原文件名 `survey`。

```
survey <- read.csv (file.choose())



```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323578433.png/wm)

**表 3-5　问卷调查数据的开头部分（已按回答 6 排序）**

| 编号   | 立场   | 回答 6 | 回答 7  |
| ---- | ---- | ---- | ----- |
| 1    | 顾客   | 商品齐全 | 无回答   |
| 2    | 顾客   | 商品齐全 | 无回答   |
| 3    | 顾客   | 商品齐全 | 传统吉祥物 |
| 4    | 顾客   | 商品齐全 | 萌系美少女 |
| 5    | 顾客   | 商品齐全 | 萌系美少女 |
| 6    | 顾客   | 商品齐全 | 传统吉祥物 |

其实我刚录入完时起的文件名是 “问卷调查 .csv”，但是逸子小姐昨天告诉我“文件名起成中文的会被阿幸骂哟”。话虽如此，可我根本不知道该起什么样的文件名，最后还是逸子小姐出的主意，把文件名起成了“调查” 的英文 survey。

“接下来，把这个数据的**回答 6** 和**立场**这 2 列制成列联表。虽说列名也是用英文比较好，但这次我就不要求那么多了。”

好险好险。总之先继续吧。

“然后，生成列联表要用 `table()`。”

我一边说着，一边就要抬手敲键盘。

“但有一点需要注意。这份数据除了**回答 6** 和**立场**之外还有其他列。直接使用 `table` 函数的话，那些没用的列也会加入列联表。所以必须把要生成列联表的列指定出来。你试试用刚才说的管道运算符 `%> %`，左边写数据名，右边写英文 `select`。”

“这样吗？”

```
survey %>% select



```

“对。然后在 `select` 后面加个圆括号。括号里先写**立场**再写**回答 6**，中间用逗号隔开。”

```
survey %>% select (立场, 回答6)



```

“这是指定只用这 2 列？”

“没错。现在只要再加个管道运算符，然后在右侧指定 `table` 函数，就能生成这 2 列的列联表了。”

```
> table1 <- survey %>% select (立场, 回答6) %>% table ; table1



```

　

```
      回答6
立场        促销    服务态度好      活动     商品齐全
  店主        11         9           38         42
  顾客        39        35           11         18



```

“啊！出来了。”

见到列联表顺利生成，我高兴得不禁叫出声来。

“嗯，不错。然后你对这表有什么看法？”

“诶？”

我所有注意力全集中在 RStudio 的操作上，压根没想着去分析统计结果。她这一问让我有点儿不知所措。

“先画个图好了。”

天羽小姐拉走键盘飞快地敲了一阵，然后按下 Enter 键。

*为了使图表更加美观，本书中使用的是 ggplot2 程序包*

```
> install.packages("ggplot2")
> library(ggplot2)



```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323609767.png/wm)

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323622817.png/wm)

```
> table1 %>% as.data.frame %>% ggplot(aes (x = 立场, y = Freq, fill
 = 回答6)) + geom_bar(stat="identity") + ylab("人数")




```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323636882.png/wm)

**图 3-1　列联表的图（⇒ Code03-01）**

“这样是不是直观一些了？”

天羽小姐把屏幕转向我。

“嗯，确实。顾客的回答里，大部分认为促销和服务态度好是商业街的魅力所在，而店主们明显更倾向于商品齐全和活动这 2 个选项。”

“这个谁都能看出来。我是问从结果中能获得什么信息。”

她用手指戳了戳我的后脑勺。

“啊？好吧。呃…… 店主们比较重视商品是否齐全，但顾客们对促销的关心程度远胜于此，也就是说顾客追求的是‘实惠’。然后，店主们在搞活动方面花了不少心思，但顾客们对此兴趣不大，反而更重视店家的服务态度。啊，还有，有 35 名顾客对商业街的服务态度表示满意，但选了这一项的店主只有 9 人，这或许能说明店主对自己的服务质量缺乏自信。”

表述自己看法的过程中，我一直小心翼翼地观察着天羽小姐的表情。她全程都在微微点头，看来我没说错什么。

“但这只是我的个人看法，就这样下结论真的好吗？”

“不好。”

否定得很干脆。

“但是别误会，你的解释还是很不错的。但顾客与店主的意见之间是否存在显著偏差，我们还得从客观角度加以判断。”

“您是指……”

“当然是独立性检验。”

“用刚才讲的卡方检验吗？”

“对。动手之前先来确认一下假设。首先是零假设，**店主与顾客的回答是独立的**。这里的独立是指‘店主与顾客的回答跟他们的立场完全没有关系’。”

“那么，不独立又是指什么呢？”

“指店主与顾客的意见受各自立场的影响。说白了就是店主和顾客的意见不同。你在刚才那条代码的右端再加一个管道运算符，右边写上 `chisq.test`，然后再执行一下看看。”

```
> survey %>% select(立场, 回答6) %>% table %>% chisq.test



```

　

```
    Pearson's Chi-squared test

data: .
X-squared = 55.489, df = 3, p-value = 5.4e-12



```

看来，RStudio 可以通过管道运算符从左至右依次执行命令。虽说输出结果是英文这点我还不大适应，但已经能看懂 `p-value = 5.4e-12` 表示 *P* 值为 5.4e-12 了。至于 e-12 这个奇怪的符号，它表示前面数字的数量级，所以 5.4e-12 就意味着要把 5 和 4 之间的小数点向左移动 12 位，即 0.0000000000054。这个概率几乎等于零，显然属于不足 5% 的情况。

“这是说有显著偏差吧？”

天羽小姐点点头，用中指推了推眼镜。

“没错。于是现在要抛弃零假设，采信备择假设。简而言之，就是店主和顾客对商业街的印象不同。嗯？你写什么呢？”

“呃，刚才用的那个方法我怕忘了，正在做笔记。”

我在常用的笔记本上又加了一句 “频率数据要制成列联表，然后进行独立性检验”。

- **俵太整理的数据：商业街问卷调查的分析**

  ![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.007.png)

“其实吧，正常的顺序应该是先提出假设，然后再进行问卷调查或实验来检验假设是否成立才对。”

## 3.5　这是搞啥

“另外确实如你所说，顾客们对‘服务态度’的满意度很高，店主们却认为自己的服务还不够到位。”

“这是为什么呢？”

“唔，这个呀……”

我这才发现对桌坐着逸子小姐。刚才为了跟上天羽小姐的实地指导，我调用了全部脑细胞，根本没注意到逸子小姐已经回来了。

“你想嘛，现在有很多顾客不愿意被店员问长问短的。过去，都是店里人主动跟顾客搭搭话，问问这问问那，然后推荐些顾客可能喜欢的商品。但现在不能这么做了，所以那些古板的店主们会觉得自己怠慢了顾客，对顾客招呼不周。”

确实是这样。包括我在内，也对进店就问年龄问职业的做法很是无语。但放到过去，店主与顾客之间或许正是通过这些交流建立信任，从而达到双赢的局面。

“正好，趁这个机会把回答 7 也分析一下，看看店主和顾客在吉祥物的选择上是不是也有分歧。”

天羽小姐单手往我背上用力一拍，似乎是让我再从头来一遍。

呃，数据已经加载到 RStudio 里了，名称是 `survey`，现在要指定**立场**和**回答 7** 这 2 列，这么写应该没错。

```
survey %>% select (立场, 回答7)



```

再在后面接上 `table` 函数，生成这 2 列的列联表。

```
> survey %>% select(立场, 回答7) %>% table



```

最后敲 Enter。

```
      回答7
立场        传统吉祥物      萌系美少女      无回答
  店主           3              97              0
  顾客          39              36             28



```

“这是搞啥！？”

听到天羽小姐一声惊呼，我还以为自己弄错了什么，吓得缩起了脖子。可定睛一看，貌似跟我没什么关系。对面的逸子小姐见状也离开了自己的座位，过来瞅了瞅我的电脑屏幕。

“咦？几乎所有店主都选了萌系美少女耶……”

逸子小姐和天羽小姐面面相觑。

“这肯定是朔太郎干的。”

“朔太郎？”

“就是玩具店的少掌柜兼商业街会计负责人，还是商业街的头号宅男……”

逸子小姐咯咯地笑着。

“这帮人居然把朔太郎说的话当真。”

天羽小姐一脸不爽。

“姑且检验一下？”

“你傻啊？别管这玩意了。顾客和店主的意见明摆着有分歧，这不

用做检验也能看出来。何况这数据根本不能用卡方检验。没填答案的顾客太多了。就算退一万步讲，把无回答的部分忽略掉，店主那边支持传统吉祥物的也只有 3 个人。数据分析有一个很简单的标准，只要列联表中存在不足 5 的频数，就要尽量避免使用卡方检验。”

“那咱们究竟该怎么跟商业街会长说呢？”

逸子小姐歪着头说道。

“顾客的回答基本是两边一样多，选哪个都不合适。话又说回来了，有这么多问卷压根没填答案，证明顾客对这东西并不感兴趣。结合刚才的回答 6 来看，他们期待的反而是促销。所以我觉得，与其在吉祥物这种无聊的玩意儿上浪费商业街的预算，不如老老实实地搞一些打折促销来得实在。真要命，会长老大不小的了究竟在琢磨什么呢？”

“是呢。要把樱田先生叫来吗？”

天羽小姐点了点头。我脑中隐约浮现出樱田会长缩着脖子挨天羽小姐骂的模样。

“喂，俵太，别在那边傻笑了。你回头去帮会长一起策划个正经点儿的调查方案出来。”

突然接到这么个任务，我瞬间懵了。

“我…… 我不行啊。我上学的时候也从来没做过调查。”

“商业街的店主们也不比你好到哪去。但他们很忙，哪像你这么闲。所以你去找几本书学学，然后趁这机会实践一下。又不是让你拿到学会去发表，只要够给商业街的店主们做个参考就行了。”

![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.008.png)

“就是啦。总之先试试看呗。”

结果连逸子小姐也在 “怂恿” 我。话说回来，总经理对普通员工说 “你这么闲” 也算是奇闻一件了吧？我脸上虽然不情不愿，但这情况也由不得我不点头了。

** 到此案件结束，读者可以像主人公俵太一样学习策划出一个正经的调查方案，然后提交实验报告到平台上，和大家一起讨论分享 **

## 四. 天羽总经理的统计学指南

### 4.1 数据的录入方式

> 每个测定对象占一行，自上而下排列。每个测定值占一列，自左至右录入。举个例子，现在要录入某初中 2 个科目的期末考试成绩，此时最好不要每个科目都做一张表。
>
> ![{%}](http://www1.ituring.com.cn/figures/2017/RookieDetective/07.d03z.009.png)
>
> 此外，在进行问卷调查时，要避免出现让答卷者难以抉择的问题或选项。比如 “经常光顾” 中的 “经常”，具体光顾多少次才能算是“经常”，不同答卷者会有不同的标准。所以，这种情况应当用“1 周 5 次以上” 之类明确的次数作为选项，让答卷者从中进行选择。

### 4.2 列联表

> 这是对照 2 个属性时所用的统计表。属性在数据分析中也称为名义尺度，简单说来就是表示分类的数据，或者 “男或女”“支持或不支持” 这种选项。选项又称为水准，比如男女就是 2 个水准。列联表的意义就是将 2 个名义数据的水准组合在一起，统计每种组合对应的人数或个数。

### 4.3 独立性检验（卡方检验）及其方法

> 这是一个分析列联表的 2 个属性之间是否存在关联性的方法。举个例子，当我们怀疑 “男性对 A 候选人的支持率超过女性” 时，就可以用独立性检验来进行验证。用数据分析的术语来讲，如果 2 个属性之间具有关联性，就称为“不相互独立”。至于检验方法，首先要提出零假设，即“2 个属性相互独立”。比如上面这个例子的零假设就是“男女对 A 候选人的支持率相等”。在接下来的检验中，我们将通过数学方法计算该假设成立的概率。
>
> 如果概率不足 5%，则抛弃零假设，采信备择假设。备择假设是指 “2 个属性不相互独立”，对应到例子中就是 “男女对 A 候选人的支持率不相等”。如果概率大于等于 5%，则保留零假设，认为 “男女对 A 候选人的支持率基本相等”。

　

## 五. 本章出现的 ![\cal{R}](http://latex.codecogs.com/gif.latex?\cal{R}) 代码

### 5.1 加载数据

> 加载名为 `sample.csv` 的数据并以 `dat` 为名称保存，其命令如下。
>
> ```
> > dat <- read.csv ("sample.csv")
>
>
>
> ```
>
> 还可以用下述方法从对话框中选择文件。
>
> ```
> > dat <- read.csv (file.choose())
>
>
>
> ```

### 5.2 table 函数

> 这是用来生成列联表的函数。
>
> ```
> > table (dat)
>
>
>
> ```
>
> 　
>
> ```
>     RES
> SEX  N  Y
>   F  8  6
>   M  5  7
>
>
>
> ```

### 5.3 管道处理与 dplyr 程序包

> 现在我们用 “管道处理” 实现上面的效果。首先给 RStudio 安装 `dplyr` 程序包，添加额外功能。
>
> ```
> > install.packages ("dplyr")
>
>
>
> ```
>
> `dplyr` 是数据科学家 Hadley Wickam{1[Hadley Wickham 是 RStudio 的首席科学家以及 Rice University 统计系的助理教授。他是著名图形可视化软件包 ggplot2 的开发者，以及其他许多被广泛使用的软件包的作者，代表作品如 plyr、reshape2 等。——译者注]} 开发的扩展功能，其中包含许多好用的函数，让 R 能够更高效直观地操作数据。它有一种奇特的功能——管道运算符。借助管道运算符，我们可以一次性执行一连串数据处理。`dplyr` 如今已受到全世界众多 R 用户的推崇，其普及率也在日益上升。
>
> 举个例子，用管道运算符求 1 到 6 的整数的平均值（这里将 `mean(1:6)` 视为传统方法）。
>
> ```
> > library (dplyr)
> > 1:6 %>% mean
>
>
>
> ```
>
> 　
>
> ```
> [1] 3.5
>
>
>
> ```
>
> 有了这一功能，前面例子中的 `table(dat)` 可以改写成下面这样。各位可以想象成用 `%> %`（管道运算符）让数据从左边 “流向” 右边。
>
> ```
> > dat %>% table
>
>
>
> ```
>
> 　
>
> ```
>     RES
> SEX  N  Y
>   F  8  6
>   M  5  7
>
>
>
> ```

### 5.4 chisq.test 函数

> 这是进行独立性检验（卡方检验）的函数。举个例子，现在要分析男女对 A 候选人的支持率是否相等。
>
> ```
> > chisq.test (dat2)
>
>
>
> ```
>
> 　
>
> ```
>     Pearson's Chi-squared test with Yates' continuity correction
> data: dat2
> X-squared = 0.15476, df = 1, p-value = 0.694
>
>
>
> ```
>
> 这里的 *P* 值超过了 5%，所以保留零假设 “男女对 A 候选人的支持率是独立的”。
>
> 卡方检验同样可以通过管道处理来执行。这里我们借助正文中商业街调查问卷的例子，看看店主与顾客的意见之间是否具有显著偏差。其执行方法如下。
>
> ```
> > survey <- read.csv("survey.csv")
> > survey %>% select(立场, 回答6) %>% table %>% chisq.test
>
>
>
> ```
>
> 　
>
> ```
>     Pearson's Chi-squared test
>    　
> data: .
> X-squared = 55.489, df = 3, p-value = 5.4e-12
>
>
>
> ```
>
> 结果不足 5%，所以抛弃零假设 “顾客与店主的意见无显著偏差”，采信备择假设 “顾客与店主的意见存在偏差”。使用管道运算符处理数据时，通常会连用多个 `%> %`。上面执行的命令就是一个典型。
>
> ```
> 「survey %>% select(立场, 回答6)  %>% table %>% chisq.test」
>
>
>
> ```
>
> 现在我们用文字给上面这一连串处理做个补充说明。
>
> “数据名 `%>%` 选择待分析的列（`select`） `%>%` 生成列联表 `(table) %>%` 对列联表执行卡方检验”

### 5.5 Code3-1 生成条形图（P.108）

> 实际上，用下面这个命令就可以绘制出简单的条形图（即柱状图）。
>
> ```
> plot (table1)
>
>
>
> ```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323683371.png/wm)

> 但本书中的图表更加美观，使用的是 `ggplot2` 程序包。其执行方法如下。
>
> ```
> > library(ggplot2)
> > table1 %>% as.data.frame %>% ggplot(aes (x = 立场, y = Freq, fill = 回答6)) + geom_bar(stat="identity") + ylab("人数")
>
>
>
> ```
>
> 我们用 “+” 连接了 `ggplot()` 和 `geom_bar()` 这 2 个函数。这是先用 `ggplot()` 指定了数据以及 X、Y 轴对应的变量，然后在这个基础上借助 `geom_bar()` 将柱状图重叠在了一起。
>
> ![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid276733labid3175timestamp1499323714367.png/wm)
>
> ## 六 总结

本实验主要是 R 语言的初级实验，从最开始的数据导入，生成联列表，到对数据的独立性分析等，希望读者能够从一点点的实践中领略 R 语言在数据分析中的魅力。

- [立即购买《菜鸟侦探挑战数据分析》](http://www.ituring.com.cn/book/1809)