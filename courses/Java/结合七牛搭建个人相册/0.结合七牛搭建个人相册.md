

## 一、 实验说明

### 1.1 课程概述

相信很多人都知道网站一般会有很多图片，对于小型网站来说，图片放在网站服务器上不算什么，但当图片数量很大时，会造成服务器很臃肿，相应地对带宽要求也会提高，这就造成了成本的增加。其实现在已经流行云存储，我们可以把图片、大文件等放到第三方提供的云存储服务上，这会减少一部分成本。这门课程就介绍了 JavaWeb 结合七牛云存储来搭建个人相册服务。

### 1.2 预备知识
#### 1.2.1 Servlet
&gt;Servlet（Server Applet），全称 Java Servlet，未有中文译文。是用 Java 编写的服务器端程序。其主要功能在于交互式地浏览和修改数据，生成动态 Web 内容。狭义的 Servlet 是指 Java 语言实现的一个接口，广义的 Servlet 是指任何实现了这个 Servlet 接口的类，一般情况下，人们将 Servlet 理解为后者。 Servlet 运行于支持 Java 的应用服务器中。从原理上讲， Servlet 可以响应任何类型的请求，但绝大多数情况下 Servlet 只用来扩展基于 HTTP 协议的 Web 服务器。具体内容请参考：[百度百科](http://baike.baidu.com/link?url=KwyP2gawzy1GSGXhamjoPaNkSWsBUutfYn-U1Wwg0Rzj94pp8OZmDUFHqo72b2A3FgwKTd_IhMKdBzPBezyJMK)。

### 1.2.2 JSP
&gt;JSP 全名为 Java Server Pages ，中文名叫 java 服务器页面，其根本是一个简化的 Servlet 设计，它是由 Sun Microsystems 公司倡导、许多公司参与一起建立的一种动态网页技术标准。 JSP 技术有点类似 ASP 技术，它是在传统的网页 HTML（标准通用标记语言的子集）文件( .htm , .html )中插入 Java 程序段( Scriptlet )和 JSP 标记( tag )，从而形成 JSP 文件，后缀名为( *.jsp )。 用 JSP 开发的 Web 应用是跨平台的，既能在 Linux 下运行，也能在其他操作系统上运行。它实现了 Html 语法中的 java 扩展（以 &lt;%, %&gt;形式）。 JSP 与 Servlet 一样，是在服务器端执行的。通常返回给客户端的就是一个 HTML 文本，因此客户端只要有浏览器就能浏览。 JSP 技术使用 Java 编程语言编写类 XML 的 tags 和 scriptlets ，来封装产生动态网页的处理逻辑。网页还能通过 tags 和 scriptlets 访问存在于服务端的资源的应用逻辑。 JSP 将网页逻辑与网页设计的显示分离，支持可重用的基于组件的设计，使基于 Web 的应用程序的开发变得迅速和容易。 JSP ( JavaServer Pages )是一种动态页面技术，它的主要目的是将表示逻辑从 Servlet 中分离出来。具体内容请参考：[百度百科](http://baike.baidu.com/item/JSP/141543)。

#### 1.2.3 Bootstrap
&gt; Bootstrap ，来自 Twitter ，是目前很受欢迎的前端框架。 Bootstrap 是基于 HTML、CSS、JAVASCRIPT 的，它简洁灵活，使得 Web 开发更加快捷。它由 Twitter 的设计师 Mark Otto 和 Jacob Thornton 合作开发，是一个 CSS/HTML 框架。 Bootstrap 提供了优雅的 HTML 和 CSS 规范，它即是由动态 CSS 语言 Less 写成。 Bootstrap 一经推出后颇受欢迎，一直是 GitHub 上的热门开源项目，包括 NASA 的 MSNBC（微软全国广播公司）的 Breaking News 都使用了该项目。国内一些移动开发者较为熟悉的框架，如 WeX5 前端开源框架等，也是基于 Bootstrap 源码进行性能优化而来。

## 二、 七牛云准备

项目开始前，需要有一个七牛云存储的标准用户账号，请自行登录[七牛云](qiniu.com)注册。

### 2.1 创建bucket
首先登陆[七牛云开发]( https://portal.qiniu.com/create ),创建一个名为 shiyanlouphoto 的空间（即 bucket ）。如图：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668316801.png/wm)


![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668416667.png/wm)

### 2.2 得到密钥

在个人面板中选择：密钥管理，如图：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469671216420.png/wm)


即得到 Access Key 和 Secret Key 。


## 三、 数据库准备

### 3.1 创建数据库
这里我们使用 MySQL 数据库，创建名称为 shiyanloudb 的数据库：首先打开桌面上的 Xfce ，执行以下命令，启动 mysql 服务：

```
sudo service mysql start
```

如图：


![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668427993.png/wm)

```
mysql -u root
```

创建并选中数据库：

```
create database shiyanloudb DEFAULT CHARSET=utf8;

use shiyanloudb;
```

### 3.2 创建表

```
CREATE TABLE `image` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(16) DEFAULT NULL,
  `url` varchar(255) DEFAULT NULL,
  `date` datetime DEFAULT NULL,
  `user_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(16) DEFAULT NULL,
  `password` varchar(16) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
```

如图:

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668461807.png/wm)

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668468397.png/wm)


数据库准备完毕。退出 Xfce。


## 四、 创建 JavaWeb 项目

### 4.1 配置项目所需 jar 包

打开eclipse，New，选择web下面的Dynamic Web Project，创建一个名称为 ShiyanlouPhoto 的动态 Web 项目，如图：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668536956.png/wm)

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668547966.png/wm)

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469685834791.png/wm)

获取所需的 jar 包，在 Xfce 中输入：

```
wget http://labfile.oss.aliyuncs.com/courses/54/lib.tar.gz
```

解压：

```
tar -zvxf lib.tar.gz
```

将解压好的 Jar 包复制到项目的 WebContext ，下面的 WEB-INF 的 lib 。



### 4.2 Bootstrap准备
前端使用 Bootstrap ，实验楼已把 Bootstrap 所需的 css、fonts 和 js 文件打包压缩，我们只需要获取并解压，然后放到 WebContent 目录下。
获取命令，打开 Xfce ，输入：

```
wget http://labfile.oss.aliyuncs.com/courses/54/bootstrap-3.3.5-dist.tar.gz
```

解压命令

```
tar -zvxf bootstrap-3.3.5-dist.tar.gz
```
稍后，我们监理项目完成，选中如图三个文件夹拷贝到 eclipse 中项目的 WebContent 目录下。


![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668505470.png/wm)

项目目录如下：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668514534.png/wm)

下面创建项目。

### 4.3 前台页面编写
#### 4.3.1 编写 index.jsp
在 WebContent 下创建

```
&lt;%@ page language=&#34;java&#34; contentType=&#34;text/html; charset=UTF-8&#34;
    pageEncoding=&#34;UTF-8&#34;%&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;zh-cn&#34;&gt;
  &lt;head&gt;
    &lt;meta charset=&#34;utf-8&#34;&gt;
    &lt;meta http-equiv=&#34;X-UA-Compatible&#34; content=&#34;IE=edge&#34;&gt;
    &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1&#34;&gt;
    &lt;title&gt;ShiyanlouPhoto&lt;/title&gt;
    &lt;link href=&#34;css/bootstrap.min.css&#34; rel=&#34;stylesheet&#34;&gt;
    &lt;!--[if lt IE 9]&gt;
      &lt;script src=&#34;http://labfile.oss.aliyuncs.com/libs/html5shiv/3.7.2/html5shiv.min.js&#34;&gt;&lt;/script&gt;
      &lt;script src=&#34;http://labfile.oss.aliyuncs.com/respond.js/1.4.2/respond.min.js&#34;&gt;&lt;/script&gt;
    &lt;![endif]--&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class=&#34;container&#34;&gt;
    	&lt;div class=&#34;row&#34;&gt;
    		&lt;div class=&#34;col-xs-12 text-center&#34;&gt;
    			&lt;h2&gt;ShiyanlouPhoto&lt;/h2&gt;
    		&lt;/div&gt;
    	&lt;/div&gt;
    	&lt;div class=&#34;row&#34;&gt;
	    	&lt;div id=&#34;alert1&#34;  class=&#34;alert alert-success fade in text-center col-xs-2 col-xs-offset-5 hide&#34;&gt;
	    		&lt;strong&gt;RegisterSuccess&lt;/strong&gt;
	    	&lt;/div&gt;
    	&lt;/div&gt;
    	&lt;form id=&#34;form&#34; class=&#34;form-horizontal&#34; role=&#34;form&#34; style=&#34;margin-top: 73px;&#34;&gt;
		  &lt;div class=&#34;form-group&#34;  &gt;
		    &lt;label for=&#34;username&#34; class=&#34;col-xs-2 control-label col-sm-offset-3&#34; &gt;Username&lt;/label&gt;
		    &lt;div class=&#34;col-xs-2&#34;&gt;
		      &lt;input type=&#34;text&#34; class=&#34;form-control&#34; id=&#34;username&#34; rel=&#34;tooltip&#34;/&gt;
		    &lt;/div&gt;
		  &lt;/div&gt;
		  &lt;div class=&#34;form-group&#34;&gt;
		    &lt;label for=&#34;password&#34; class=&#34;col-xs-2 control-label col-sm-offset-3&#34;&gt;Password&lt;/label&gt;
		    &lt;div class=&#34;col-xs-2&#34;&gt;
		      &lt;input type=&#34;password&#34; class=&#34;form-control&#34; id=&#34;password&#34;/&gt;
		    &lt;/div&gt;
		  &lt;/div&gt;
		  &lt;div class=&#34;form-group&#34;&gt;
		    &lt;div class=&#34;col-sm-offset-5 col-xs-1&#34;&gt;
		      &lt;button type=&#34;button&#34; class=&#34;btn btn-success&#34; id=&#34;login&#34;&gt;Login&lt;/button&gt;
		    &lt;/div&gt;
		    &lt;div class=&#34;col-sm-1&#34;&gt;
		      &lt;button type=&#34;button&#34; class=&#34;btn btn-danger&#34; data-toggle=&#34;modal&#34; data-target=&#34;#myModal&#34;&gt;Register&lt;/button&gt;
		    &lt;/div&gt;
		  &lt;/div&gt;
		&lt;/form&gt;
    &lt;/div&gt;
	
	&lt;!-- 注册对话框 begin --&gt;
	&lt;div class=&#34;modal fade&#34; id=&#34;myModal&#34; tabindex=&#34;-1&#34; role=&#34;dialog&#34; aria-labelledby=&#34;myModalLabel&#34; aria-hidden=&#34;true&#34;&gt;
	  &lt;div class=&#34;modal-dialog&#34;&gt;
	    &lt;div class=&#34;modal-content&#34;&gt;
	      &lt;div class=&#34;modal-header&#34;&gt;
	        &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34;&gt;&lt;span aria-hidden=&#34;true&#34;&gt;&amp;times;&lt;/span&gt;&lt;span class=&#34;sr-only&#34;&gt;Close&lt;/span&gt;&lt;/button&gt;
	        &lt;h4 class=&#34;modal-title&#34; id=&#34;myModalLabel&#34;&gt;UserRegister&lt;/h4&gt;
	      &lt;/div&gt;
	      &lt;div class=&#34;modal-body&#34;&gt;
	      	&lt;form class=&#34;form-horizontal&#34; role=&#34;form&#34;&gt;
			  &lt;div class=&#34;form-group&#34;  &gt;
			    &lt;label for=&#34;reg_username&#34; class=&#34;col-xs-2 control-label&#34; &gt;Username&lt;/label&gt;
			    &lt;div class=&#34;col-xs-4&#34;&gt;
			      &lt;input type=&#34;text&#34; class=&#34;form-control&#34; id=&#34;reg_username&#34;/&gt;
			    &lt;/div&gt;
			  &lt;/div&gt;
			  &lt;div class=&#34;form-group&#34;&gt;
			    &lt;label for=&#34;reg_password&#34; class=&#34;col-xs-2 control-label&#34;&gt;Password&lt;/label&gt;
			    &lt;div class=&#34;col-xs-4&#34;&gt;
			      &lt;input type=&#34;password&#34; class=&#34;form-control&#34; id=&#34;reg_password&#34;/&gt;
			    &lt;/div&gt;
			  &lt;/div&gt;
			  &lt;div class=&#34;form-group&#34;&gt;
			    &lt;label for=&#34;reg_repassword&#34; class=&#34;col-xs-2 control-label&#34;&gt;Reinput&lt;/label&gt;
			    &lt;div class=&#34;col-xs-4&#34;&gt;
			      &lt;input type=&#34;password&#34; class=&#34;form-control&#34; id=&#34;reg_repassword&#34;/&gt;
			    &lt;/div&gt;
			  &lt;/div&gt;
			&lt;/form&gt;
	      &lt;/div&gt;
	      &lt;div class=&#34;modal-footer&#34;&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-default&#34; data-dismiss=&#34;modal&#34;&gt;Cancel&lt;/button&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#34;register&#34;&gt;Register&lt;/button&gt;
	      &lt;/div&gt;
	    &lt;/div&gt;
	  &lt;/div&gt;
	&lt;/div&gt;
	&lt;!-- 注册对话框 end --&gt;
	
    &lt;script src=&#34;http://labfile.oss.aliyuncs.com/jquery/1.11.1/jquery.min.js&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;js/bootstrap.min.js&#34;&gt;&lt;/script&gt;
    &lt;script type=&#34;text/javascript&#34;&gt;
    	$(document).ready(function() {
    		//点击登录
    		$(&#39;#login&#39;).click(function() {
    			//提交登录表单
    			$.post(&#39;${pageContext.request.contextPath}&#39; + &#39;/UserAction?type=1&#39;,
				{
					username: $(&#39;#username&#39;).val(),
					password: $(&#39;#password&#39;).val()
				},
				function(data, status) {
					if (data == &#39;1&#39;) {
						createPopOver(&#39;#username&#39;, &#39;right&#39;, &#39;Username can not be empty &#39;, &#39;show&#39;);
					} else if (data == &#39;2&#39;) {
						createPopOver(&#39;#password&#39;, &#39;right&#39;, &#39; password can not be empty&#39;, &#39;show&#39;);
					} else if (data == &#39;3&#39;) {
						createPopOver(&#39;#username&#39;, &#39;right&#39;, &#39; Username does not exist&#39;, &#39;show&#39;);
					} else if (data == &#39;4&#39;) {
						createPopOver(&#39;#password&#39;, &#39;right&#39;, &#39; wrong password&#39;, &#39;show&#39;);
					} else if (data == 5) {
						location.href = &#39;${pageContext.request.contextPath}&#39; + &#39;/home.jsp&#39;;
					}
				});
    		});
    		
    		//点击注册按钮
    		$(&#39;#register&#39;).click(function() {
    			//提交注册表单
    			$.post(&#39;${pageContext.request.contextPath}&#39; + &#39;/UserAction?type=2&#39;,
				{
					username: $(&#39;#reg_username&#39;).val(),
					password: $(&#39;#reg_password&#39;).val(),
					repassword: $(&#39;#reg_repassword&#39;).val()
				},
				function(data, status) {
					if (data == &#39;1&#39;) {
						createPopOver(&#39;#reg_username&#39;, &#39;right&#39;, &#39;not null&#39;, &#39;show&#39;);
					} else if (data == &#39;2&#39;) {
						createPopOver(&#39;#reg_password&#39;, &#39;right&#39;, &#39;not null&#39;, &#39;show&#39;);
					} else if (data == &#39;3&#39;) {
						createPopOver(&#39;#reg_repassword&#39;, &#39;right&#39;, &#39;not null&#39;, &#39;show&#39;);
					} else if (data == &#39;4&#39;) {
						createPopOver(&#39;#reg_repassword&#39;, &#39;right&#39;, &#39;Passwords do not match&#39;, &#39;show&#39;);
					} else if (data == &#39;5&#39;) {
						createPopOver(&#39;#reg_username&#39;, &#39;right&#39;, &#39;Username already exists&#39;, &#39;show&#39;);
					} else if (data == &#39;6&#39;) {
						$(&#39;#reg_username&#39;).val(&#39;&#39;);
						$(&#39;#reg_password&#39;).val(&#39;&#39;);
						$(&#39;#reg_repassword&#39;).val(&#39;&#39;);
						$(&#39;#myModal&#39;).modal(&#39;hide&#39;);
						$(&#39;#alert1&#39;).removeClass(&#39;hide&#39;);
						$(&#39;#form&#39;).css(&#39;margin-top&#39;, &#39;0px&#39;);
					}
				});
    		}); 
    		
    		//显示弹出框
    		function createPopOver(id, placement, content, action) {
    			$(id).popover({
					placement: placement,
					content: content
				});
				$(id).popover(action);
    		}
    		
    		//点击输入框时销毁弹出框
    		$(&#39;#username&#39;).click(function() {
    			$(&#39;#username&#39;).popover(&#39;destroy&#39;);
    		});
    		
    		$(&#39;#password&#39;).click(function() {
    			$(&#39;#password&#39;).popover(&#39;destroy&#39;);
    		});
    		
    		$(&#39;#reg_username&#39;).click(function() {
    			$(&#39;#reg_username&#39;).popover(&#39;destroy&#39;);
    		});
    		
    		$(&#39;#reg_password&#39;).click(function() {
    			$(&#39;#reg_password&#39;).popover(&#39;destroy&#39;);
    		});
    		
    		$(&#39;#reg_repassword&#39;).click(function() {
    			$(&#39;#reg_repassword&#39;).popover(&#39;destroy&#39;);
    		});
    	});
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
```

#### 4.3.2 编写 home.jsp

```
&lt;%@ page language=&#34;java&#34; contentType=&#34;text/html; charset=UTF-8&#34;
    pageEncoding=&#34;UTF-8&#34;%&gt;
&lt;%@ taglib prefix=&#34;c&#34; uri=&#34;http://java.sun.com/jsp/jstl/core&#34; %&gt;
&lt;%@ taglib prefix=&#34;fmt&#34; uri=&#34;http://java.sun.com/jsp/jstl/fmt&#34; %&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;zh-cn&#34;&gt;
  &lt;head&gt;
    &lt;meta charset=&#34;utf-8&#34;&gt;
    &lt;meta http-equiv=&#34;X-UA-Compatible&#34; content=&#34;IE=edge&#34;&gt;
    &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1&#34;&gt;
    &lt;title&gt;${user.username}Photo&lt;/title&gt;
    &lt;link href=&#34;css/bootstrap.min.css&#34; rel=&#34;stylesheet&#34;&gt;
    &lt;!--[if lt IE 9]&gt;
      &lt;script src=&#34;http://labfile.oss.aliyuncs.com/libs/html5shiv/3.7.2/html5shiv.min.js&#34;&gt;&lt;/script&gt;
      &lt;script src=&#34;http://labfile.oss.aliyuncs.com/respond.js/1.4.2/respond.min.js&#34;&gt;&lt;/script&gt;
    &lt;![endif]--&gt;
  &lt;/head&gt;
  &lt;body&gt;
	&lt;div class=&#34;container&#34;&gt;
		&lt;!-- 首部 start --&gt;
		&lt;div class=&#34;row&#34;&gt;
			&lt;div class=&#34;col-xs-8 col-xs-offset-2&#34;&gt;
				&lt;h3 class=&#34;page-header&#34;&gt;
					${user.username}&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;small&gt;Totals:&lt;span class=&#34;badge&#34;&gt;${imageList.size()}&lt;/span&gt;&lt;/small&gt;
					&lt;div class=&#34;btn-group pull-right&#34;&gt;
					  &lt;button type=&#34;button&#34; class=&#34;btn btn-primary dropdown-toggle&#34; data-toggle=&#34;dropdown&#34;&gt;
					  	options&lt;span class=&#34;caret&#34;&gt;&lt;/span&gt;
					  &lt;/button&gt;
					  &lt;ul class=&#34;dropdown-menu&#34; role=&#34;menu&#34;&gt;
					    &lt;li&gt;&lt;a href=&#34;#&#34; data-toggle=&#34;modal&#34; data-target=&#34;#myModa2&#34;&gt;Upload&lt;/a&gt;&lt;/li&gt;
					    &lt;li&gt;&lt;a href=&#34;#&#34; data-toggle=&#34;modal&#34; data-target=&#34;#myModa3&#34;&gt;Delete&lt;/a&gt;&lt;/li&gt;
					    &lt;li&gt;&lt;a href=&#34;#&#34; data-toggle=&#34;modal&#34; data-target=&#34;#myModa4&#34;&gt;Exit&lt;/a&gt;&lt;/li&gt;
					  &lt;/ul&gt;
					&lt;/div&gt;
				&lt;/h3&gt;
			&lt;/div&gt;
		&lt;/div&gt;
		&lt;!-- 首部 end --&gt;
		
		&lt;!-- 显示图片列表 --&gt;
		&lt;c:forEach items=&#34;${imageList}&#34; varStatus=&#34;status&#34; var=&#34;image&#34;&gt;
			&lt;c:choose&gt;
				&lt;c:when test=&#34;${status.first or status.index % 4 eq 0}&#34;&gt;
					&lt;div class=&#34;row&#34;&gt;
						&lt;div class=&#34;col-xs-2 col-xs-offset-2&#34;&gt;
						  &lt;a href=&#34;#&#34; class=&#34;thumbnail text-center&#34;&gt;
						    &lt;img name=&#34;${image.name}&#34; date=&#34;&lt;fmt:formatDate value=&#39;${image.date}&#39; pattern=&#39;yyyy-MM-dd HH:mm&#39;/&gt;&#34; style=&#34;width: 140px; height: 130px;&#34; src=&#34;http:///oayqj2sj0.bkt.clouddn.com/${image.url}&#34;&gt;&lt;!--这里请填写自己的链接地址，详见下图--&gt;
						    &lt;input class=&#34;pull-left&#34; type=&#34;checkbox&#34; value=&#34;${image.id}&#34; url=&#34;${image.url}&#34;/&gt;${image.name }
						  &lt;/a&gt;
						&lt;/div&gt;
				&lt;/c:when&gt;
				&lt;c:when test=&#34;${status.index % 4 eq 3 and not status.last }&#34;&gt;
						&lt;div class=&#34;col-xs-2&#34;&gt;
						  &lt;a href=&#34;#&#34; class=&#34;thumbnail text-center&#34;&gt;
						    &lt;img name=&#34;${image.name}&#34; date=&#34;&lt;fmt:formatDate value=&#39;${image.date}&#39; pattern=&#39;yyyy-MM-dd HH:mm&#39;/&gt;&#34; style=&#34;width: 140px; height: 130px;&#34; src=&#34;http://oayqj2sj0.bkt.clouddn.com/${image.url}&#34;&gt;&lt;!--这里请填写自己的链接地址，详见下图--&gt;
						    &lt;input class=&#34;pull-left&#34; type=&#34;checkbox&#34; value=&#34;${image.id}&#34; url=&#34;${image.url}&#34; /&gt;${image.name }
						  &lt;/a&gt;
						&lt;/div&gt;
					&lt;/div&gt;
				&lt;/c:when&gt;
				&lt;c:otherwise&gt;
					&lt;div class=&#34;col-xs-2&#34;&gt;
					  &lt;a href=&#34;#&#34; class=&#34;thumbnail text-center&#34;&gt;
					    &lt;img name=&#34;${image.name}&#34; date=&#34;&lt;fmt:formatDate value=&#39;${image.date}&#39; pattern=&#39;yyyy-MM-dd HH:mm&#39;/&gt;&#34; style=&#34;width: 140px; height: 130px;&#34; src=&#34;http:///oayqj2sj0.bkt.clouddn.com/${image.url}&#34;&gt;&lt;!--这里请填写自己的链接地址，详见下图--&gt;
					    &lt;input class=&#34;pull-left&#34; type=&#34;checkbox&#34; value=&#34;${image.id}&#34; url=&#34;${image.url}&#34;/&gt;${image.name }
					  &lt;/a&gt;
					&lt;/div&gt;
				&lt;/c:otherwise&gt;
			&lt;/c:choose&gt;
			&lt;c:if test=&#34;${status.last}&#34;&gt;
				&lt;/div&gt;
			&lt;/c:if&gt;
		&lt;/c:forEach&gt;
		&lt;!-- 显示图片列表 end --&gt;
	&lt;/div&gt;
	
	&lt;!-- 显示图片对话框 start --&gt;
	&lt;div class=&#34;modal fade&#34; id=&#34;myModal&#34; tabindex=&#34;-1&#34; role=&#34;dialog&#34; aria-labelledby=&#34;myModalLabel&#34; aria-hidden=&#34;true&#34;&gt;
	  &lt;div class=&#34;modal-dialog&#34;&gt;
	    &lt;div class=&#34;modal-content&#34;&gt;
	      &lt;div class=&#34;modal-header&#34;&gt;
	        &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34; aria-hidden=&#34;true&#34;&gt;&amp;times;&lt;/button&gt;
	        &lt;h4 class=&#34;modal-title&#34; id=&#34;myModalLabel&#34;&gt;&lt;/h4&gt;
	      &lt;/div&gt;
	      &lt;div class=&#34;modal-body&#34; id=&#34;modal-content&#34;&gt;
	      &lt;/div&gt;
	    &lt;/div&gt;
	  &lt;/div&gt;
	&lt;/div&gt;
	&lt;!-- 显示图片对话框 end --&gt;
	
	&lt;!-- 上传图片对话框 start --&gt;
	&lt;div class=&#34;modal fade&#34; id=&#34;myModa2&#34; tabindex=&#34;-1&#34; role=&#34;dialog&#34; aria-labelledby=&#34;myModalLabel&#34; aria-hidden=&#34;true&#34;&gt;
	  &lt;div class=&#34;modal-dialog&#34;&gt;
	    &lt;div class=&#34;modal-content&#34;&gt;
	      &lt;div class=&#34;modal-header&#34;&gt;
	        &lt;h4 class=&#34;modal-title&#34; id=&#34;myModalLabe2&#34;&gt;Image Upload&lt;/h4&gt;
	      &lt;/div&gt;
	      &lt;div class=&#34;modal-body&#34;&gt;
	      	&lt;form class=&#34;form-horizontal&#34; role=&#34;form&#34; id=&#34;form&#34;&gt;
	      	  &lt;div class=&#34;form-group&#34;  &gt;
			    &lt;label for=&#34;image_name&#34; class=&#34;col-xs-2 control-label&#34; &gt;Title&lt;/label&gt;
			    &lt;div class=&#34;col-xs-4&#34;&gt;
			      &lt;input type=&#34;text&#34; class=&#34;form-control&#34; id=&#34;image_name&#34; name=&#34;image_name&#34;/&gt;
			    &lt;/div&gt;
			  &lt;/div&gt;
			  &lt;div class=&#34;form-group&#34;&gt;
			    &lt;label for=&#34;image&#34; class=&#34;col-xs-2 control-label&#34;&gt;Image&lt;/label&gt;
			    &lt;div class=&#34;col-xs-4&#34;&gt;
			    	&lt;input type=&#34;file&#34; id=&#34;image&#34; name=&#34;image&#34;/&gt;
			    &lt;/div&gt;
			  &lt;/div&gt;
			&lt;/form&gt;
	      &lt;/div&gt;
	      &lt;div class=&#34;modal-footer&#34;&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-default&#34; data-dismiss=&#34;modal&#34;&gt;Cancel&lt;/button&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#34;upload&#34;&gt;Upload&lt;/button&gt;
	      &lt;/div&gt;
	    &lt;/div&gt;
	  &lt;/div&gt;
	&lt;/div&gt;
	&lt;!-- 上传图片对话框 end --&gt;
	
	&lt;!-- 删除图片对话框 start --&gt;
	&lt;div class=&#34;modal fade&#34; id=&#34;myModa3&#34; tabindex=&#34;-1&#34; role=&#34;dialog&#34; aria-labelledby=&#34;myModalLabel&#34; aria-hidden=&#34;true&#34;&gt;
	  &lt;div class=&#34;modal-dialog&#34;&gt;
	    &lt;div class=&#34;modal-content&#34;&gt;
	      &lt;div class=&#34;modal-header&#34;&gt;
	        &lt;h4 class=&#34;modal-title&#34; id=&#34;myModalLabe3&#34;&gt;confirm to delete?&lt;/h4&gt;
	      &lt;/div&gt;
	      &lt;div class=&#34;modal-footer&#34;&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-default&#34; data-dismiss=&#34;modal&#34;&gt;Cancel&lt;/button&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-danger&#34; id=&#34;delete&#34;&gt;Confirm&lt;/button&gt;
	      &lt;/div&gt;
	    &lt;/div&gt;
	  &lt;/div&gt;
	&lt;/div&gt;
	&lt;!-- 删除图片对话框 end --&gt;
	
	&lt;!-- 退出对话框 start --&gt;
	&lt;div class=&#34;modal fade&#34; id=&#34;myModa4&#34; tabindex=&#34;-1&#34; role=&#34;dialog&#34; aria-labelledby=&#34;myModalLabel&#34; aria-hidden=&#34;true&#34;&gt;
	  &lt;div class=&#34;modal-dialog&#34;&gt;
	    &lt;div class=&#34;modal-content&#34;&gt;
	      &lt;div class=&#34;modal-header&#34;&gt;
	        &lt;h4 class=&#34;modal-title&#34; id=&#34;myModalLabe4&#34;&gt;confirm to exit?&lt;/h4&gt;
	      &lt;/div&gt;
	      &lt;div class=&#34;modal-footer&#34;&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-default&#34; data-dismiss=&#34;modal&#34;&gt;Cancel&lt;/button&gt;
	        &lt;button type=&#34;button&#34; class=&#34;btn btn-danger&#34; id=&#34;exit&#34;&gt;Confirm&lt;/button&gt;
	      &lt;/div&gt;
	    &lt;/div&gt;
	  &lt;/div&gt;
	&lt;/div&gt;
	&lt;!-- 退出对话框 end --&gt;
	
    &lt;script src=&#34;http://labfile.oss.aliyuncs.com/jquery/1.11.1/jquery.min.js&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;js/bootstrap.min.js&#34;&gt;&lt;/script&gt;
    &lt;script type=&#34;text/javascript&#34;&gt;
    	$(document).ready(function() {
    		//点击图片
    		$(&#39;img&#39;).click(function() {
    			$(&#39;#myModalLabel&#39;).html($(this).attr(&#39;name&#39;) + &#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;small&gt;&#39; + $(this).attr(&#39;date&#39;) + &#39;&lt;/small&gt;&#39;);
    			$(&#39;#modal-content&#39;).html(&#39;&lt;img class=\&#39;img-responsive\&#39; src=\&#39;&#39; + $(this).attr(&#39;src&#39;) + &#39;\&#39;/&gt;&#39;);
    			$(&#39;#myModal&#39;).modal(&#39;show&#39;);
    		});
    		
    		//点击上传
    		$(&#39;#upload&#39;).click(function() {
    			if ($(&#39;#image_name&#39;).val() == &#39;&#39; || $(&#39;#image&#39;).val() == &#39;&#39;) {
    			} else {
    				$(&#39;#form&#39;).attr(&#39;action&#39;, &#39;${pageContext.request.contextPath}&#39; + &#39;/ImageAction?type=1&#39;);
        			$(&#39;#form&#39;).attr(&#39;enctype&#39;, &#39;multipart/form-data&#39;);
        			$(&#39;#form&#39;).attr(&#39;method&#39;, &#39;post&#39;);
        			$(&#39;#form&#39;).submit();
    			}
    		});
			
    		//点击确定退出
    		$(&#39;#exit&#39;).click(function() {
    			$.get(&#39;${pageContext.request.contextPath}&#39; + &#39;/UserAction?type=3&#39;, function(data, status) {
    				location.href = &#39;${pageContext.request.contextPath}&#39; + &#39;/index.jsp&#39;;
    			});
    		});
    		
    		//点击确定删除图片
    		$(&#39;#delete&#39;).click(function() {
    			var ids = &#34;&#34;;
    			var urls = &#34;&#34;;
    			$(&#39;input[type=checkbox]:checked&#39;).each(function() {
    				ids += $(this).val() + &#39;,&#39;;
    				urls += $(this).attr(&#39;url&#39;) + &#39;,&#39;;
    			}); 
				$.post(&#39;${pageContext.request.contextPath}&#39; + &#39;/ImageAction?type=2&#39;, {
					ids: ids,
					urls: urls
				},function(data, status) {
					$(&#39;#myModa3&#39;).modal(&#39;hide&#39;);
					location.href = &#39;${pageContext.request.contextPath}&#39; + &#39;/home.jsp&#39;;
				});
    		});
    	});
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
```
链接地址：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469672932333.png/wm)

### 4.4 编写后台代码

#### 4.4.1 创建 User 类

```
package com.shiyanlou.photo.domain;

import java.io.Serializable;
import java.util.List;

/**
 * 用户类
 * @author www.shiyanlou.com
 *
 */
@SuppressWarnings(&#34;serial&#34;)
public class User implements Serializable {
	private int id;	//用户ID
	private String username;	//用户名
	private String password;	//密码
	private List&lt;Image&gt; images;	//图片列表

	public User() {
	}

	public User(int id, String username, String password, List&lt;Image&gt; images) {
		this.id = id;
		this.username = username;
		this.password = password;
		this.images = images;
	}
	
	public User(String username, String password) {
		this.username = username;
		this.password = password;
	}

	public User(int id) {
		this.id = id;
	}
	
	public List&lt;Image&gt; getImages() {
		return images;
	}

	public void setImages(List&lt;Image&gt; images) {
		this.images = images;
	}

	public int getId() {
		return id;
	}

	public void setId(int id) {
		this.id = id;
	}

	public String getUsername() {
		return username;
	}

	public void setUsername(String username) {
		this.username = username;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

}
```

#### 4.4.2 创建 Image 类
 
```
package com.shiyanlou.photo.domain;

import java.io.Serializable;
import java.util.Date;

/**
 * 图片类
 * @author www.shiyanlou.com
 *
 */
@SuppressWarnings(&#34;serial&#34;)
public class Image implements Serializable {
	private int id;	//图片ID
	private String name;	//图片名
	private String url;	//图片URL
	private Date date;	//上传时间
	private User user;	//所属用户
	
	public int getId() {
		return id;
	}
	public void setId(int id) {
		this.id = id;
	}
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public String getUrl() {
		return url;
	}
	public void setUrl(String url) {
		this.url = url;
	}
	public Date getDate() {
		return date;
	}
	public void setDate(Date date) {
		this.date = date;
	}
	public User getUser() {
		return user;
	}
	public void setUser(User user) {
		this.user = user;
	}
}
```

#### 4.4.3 创建数据库工具类 DBUtils

```
package com.shiyanlou.photo.util;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;

/**
 * 数据库工具类
 * @author www.shiyanlou.com
 *
 */
public class DBUtils {
	private static Connection connection = null;
	private static PreparedStatement preparedStatement = null;
	private static ResultSet resultSet = null;
	
	//初始化
	static {
		try {
			Class.forName(&#34;com.mysql.jdbc.Driver&#34;);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * 获取连接
	 * @return
	 */
	private static Connection getConnection() {
		try {
			connection = DriverManager.getConnection(&#34;jdbc:mysql://localhost:3306/shiyanloudb?useUnicode=true&amp;characterEncoding=UTF-8&#34;, &#34;root&#34;, &#34;&#34;);//将数据库名字修改为自己的数据库，root 为账户名，本实验环境 mysql 密码为空
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return connection;
	}
	
	/**
	 * 关闭连接、预处理语句和结果集
	 * @param connection
	 * @param preparedStatement
	 * @param resultSet
	 */
	private static void close(Connection connection, PreparedStatement preparedStatement, ResultSet resultSet) {
		try {
			if (resultSet != null) {
				resultSet.close();
				resultSet = null;
			}
			
			if (preparedStatement != null) {
				preparedStatement.close();
				preparedStatement = null;
			}
			
			if (connection != null) {
				connection.close();
				connection = null;
			}			
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	/**
	 * 查询数据库
	 * @param sql SQL语句
	 * @param parameters 参数
	 * @return
	 */
	public static ArrayList&lt;Object[]&gt; query(String sql, String[] parameters) {
		ArrayList&lt;Object[]&gt; list = new ArrayList&lt;Object[]&gt;();
		try {
			connection = getConnection();
			preparedStatement = connection.prepareStatement(sql);
			for (int i = 0; i &lt; parameters.length; i++) {
				preparedStatement.setString(i + 1, parameters[i]);
			}
			resultSet = preparedStatement.executeQuery();
			int columnCount = resultSet.getMetaData().getColumnCount();
			
			while (resultSet.next()) {
				Object[] objects = new Object[columnCount];
				for (int i = 0; i &lt; columnCount; i++) {
					objects[i] = resultSet.getObject(i + 1);
				}
				list.add(objects);
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			close(connection, preparedStatement, resultSet);
		}
		return list;
	}
	
	/**
	 * 更新数据库
	 * @param sqls SQL语句数组
	 * @param parameters 参数数组
	 */
	public static void updates(String[] sqls, String[][] parameters) {
		try {
			connection = getConnection();
			connection.setAutoCommit(false);
			for (int i = 0; i &lt; sqls.length; i++) {
				preparedStatement = connection.prepareStatement(sqls[i]);
				for (int j = 0; j &lt; parameters[i].length; j++) {
					preparedStatement.setString(j + 1, parameters[i][j]);
				}
				preparedStatement.executeUpdate();
			}
			connection.commit();
		} catch (Exception e) {
			try {
				connection.rollback();
			} catch (SQLException e1) {
				e1.printStackTrace();
			}
			e.printStackTrace();
		} finally {
			close(connection, preparedStatement, resultSet);
		}
	}
}
```

#### 4.4.4 创建文件工具类 FileUtils（使用了七牛云存储服务）
```
package com.shiyanlou.photo.util;

import java.io.InputStream;

import org.json.JSONException;

import com.qiniu.api.auth.AuthException;
import com.qiniu.api.auth.digest.Mac;
import com.qiniu.api.io.IoApi;
import com.qiniu.api.rs.PutPolicy;
import com.qiniu.api.rs.RSClient;

/**
 * 图片工具类（使用七牛云存储服务）
 * @author www.shiyanlou.com
 *
 */
public class FileUtils {
	private static final String ACCESS_KEY = &#34; your Access Key&#34;;//这里填上面我们讲到的，密钥管理里面的密钥
	private static final String SECRET_KEY = &#34;your Secret Key&#34;;
	private static final String BUCKET_NAME = &#34; your Bucket Name&#34;;//填我们在七牛云创建的 Bucket 名字
	
	/**
	 * 上传图片到七牛云存储
	 * @param reader
	 * @param fileName
	 */
	public static void upload(InputStream reader, String fileName) {
		String uptoken;
		try {
			Mac mac = new Mac(ACCESS_KEY, SECRET_KEY);
			PutPolicy putPolicy = new PutPolicy(BUCKET_NAME);
			uptoken = putPolicy.token(mac);
			IoApi.Put(uptoken, fileName, reader, null);
		} catch (AuthException e) {
			e.printStackTrace();
		} catch (JSONException e) {
			e.printStackTrace();
		}
	}
	
	/**
	 * 删除七牛云存储上的图片
	 * @param key
	 */
	public static void delete( String key) {
		Mac mac = new Mac(ACCESS_KEY, SECRET_KEY);
        RSClient client = new RSClient(mac);
        client.delete(BUCKET_NAME, key);
	}
}
```

#### 4.4.5 创建用户服务类 UserService
```
package com.shiyanlou.photo.service;

import java.util.List;

import com.shiyanlou.photo.domain.User;
import com.shiyanlou.photo.util.DBUtils;

/**
 * 用户服务类
 * @author www.shiyanlou.com
 *
 */
public class UserService {
	/**
	 * 通过用户名获取用户
	 * @param username 用户名
	 * @return 用户
	 */
	public User getUserByUsername(String username) {
		String sql = &#34;select id, username, password from user where username = ?&#34;;
		String[] parameters = {username};
		List&lt;Object[]&gt; users = DBUtils.query(sql, parameters);
		if (users.size() == 0) {
			return null;
		} else {
			Object[] objects = users.get(0);
			return objects == null ? null : new User(Integer.parseInt(objects[0].toString()), objects[1].toString(), objects[2].toString(), null);
		}
	}
	
	/**
	 * 添加用户
	 * @param user 用户
	 */
	public void addUser(User user) {
		String[] sqls = {&#34;insert into user(username, password) values(?, ?)&#34;};
		String[][] parameters = {{user.getUsername(), user.getPassword()}};
		DBUtils.updates(sqls, parameters);
	}
}
```

#### 4.4.6 创建图片服务类 ImageService

```
package com.shiyanlou.photo.service;

import java.io.InputStream;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import com.shiyanlou.photo.domain.Image;
import com.shiyanlou.photo.domain.User;
import com.shiyanlou.photo.util.DBUtils;
import com.shiyanlou.photo.util.FileUtils;

/**
 * 图片服务类
 * @author www.shiyanlou.com
 *
 */
public class ImageService {
	/**
	 * 通过用户ID获取图片列表
	 * @param userId 用户ID
	 * @return 图片列表
	 */
	public ArrayList&lt;Image&gt; getByUserId(int userId) {
		ArrayList&lt;Image&gt; images = new ArrayList&lt;Image&gt;();
		String sql = &#34;select id, name, url, date, user_id from image where user_id = ? order by date desc&#34;;
		String[] parameters = {userId + &#34;&#34;};
		List&lt;Object[]&gt; imageList = DBUtils.query(sql, parameters);
		for (Object[] objects : imageList) {
			Image image = new Image();
			image.setId(Integer.parseInt(objects[0].toString()));
			image.setName(objects[1].toString());
			image.setUrl(objects[2].toString());
			image.setDate((Date) objects[3]);
			image.setUser(new User(Integer.parseInt(objects[4].toString())));
			images.add(image);
		}
		return images;
	}
	
	/**
	 * 上传图片
	 * @param image 图片
	 * @param inputStream 输入流
	 */
	public void addImage(Image image, InputStream inputStream) {
		FileUtils.upload(inputStream, image.getUrl());
		String[] sqls = {&#34;insert into image(name, url, date, user_id) values(?, ?, ?, ?)&#34;};
		String[][] parameters = {{image.getName(), image.getUrl(), new SimpleDateFormat(&#34;yyyy-MM-dd HH:mm&#34;).format(image.getDate()), image.getUser().getId() + &#34;&#34;}};
		DBUtils.updates(sqls, parameters);
	}
	
	/**
	 * 通过图片ID数组和图片URL数组删除图片
	 * @param ids 图片ID数组
	 * @param urls 图片URL数组
	 */
	public void delByIdsAndUrls(String ids, String urls) {
		String[] idArray = ids.split(&#34;,&#34;);
		String[] urlArray = urls.split(&#34;,&#34;);
		if (!&#34;&#34;.equals(idArray[0]) &amp;&amp; !&#34;&#34;.equals(urlArray[0])) {
			String[] sqls = new String[idArray.length];
			String[][] parameters = new String[idArray.length][1];
			for (int i = 0; i &lt; idArray.length; i++) {
				FileUtils.delete(urlArray[i]);
				sqls[i] = &#34;delete from image where id = ?&#34;;
				parameters[i][0] = idArray[i];
			}
			DBUtils.updates(sqls, parameters);
		}
	}
}
```

#### 4.4.7 创建用户控制器类 UserAction

```
package com.shiyanlou.photo.action;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.shiyanlou.photo.domain.User;
import com.shiyanlou.photo.service.ImageService;
import com.shiyanlou.photo.service.UserService;


/**
 * 用户控制器
 * @author www.shiyanlou.com
 *
 */
@WebServlet(value = &#34;/UserAction&#34;)
public class UserAction extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		request.setCharacterEncoding(&#34;UTF-8&#34;);
		response.setCharacterEncoding(&#34;Utf-8&#34;);
		response.setContentType(&#34;text/html;charset=UTF-8&#34;);
		PrintWriter out = response.getWriter();
		UserService userService = new UserService();
		ImageService imageService = new ImageService();
		
		Integer type = Integer.valueOf(request.getParameter(&#34;type&#34;));
		if (type == 1) {	//用户登录
			String username = request.getParameter(&#34;username&#34;);
			String password = request.getParameter(&#34;password&#34;);
			String result = null;
			User user = null;
			//验证用户是否有效
			if (username.isEmpty()) {
				result = &#34;1&#34;;
			} else if (password.isEmpty()) {
				result = &#34;2&#34;;
			} else if ((user = userService.getUserByUsername(username)) == null) {
				result = &#34;3&#34;;
			} else {
				if (!user.getPassword().equals(password)) {
					result = &#34;4&#34;;
				} else {
					request.getSession().setAttribute(&#34;user&#34;, user);
					request.getSession().setAttribute(&#34;imageList&#34;, imageService.getByUserId(user.getId()));
					result = &#34;5&#34;;
				}
			}
			out.print(result);
		} else if (type == 2) {	//用户注册
			String username = request.getParameter(&#34;username&#34;);
			String password = request.getParameter(&#34;password&#34;);
			String repassword = request.getParameter(&#34;repassword&#34;);
			String result = null;
			//验证有效性
			if (username.isEmpty()) {
				result = &#34;1&#34;;
			} else if (password.isEmpty()) {
				result = &#34;2&#34;;
			} else if (repassword.isEmpty()) {
				result = &#34;3&#34;;
			} else if (!repassword.equals(password)) {
				result = &#34;4&#34;;
			} else if (userService.getUserByUsername(username) != null) {
				result = &#34;5&#34;;
			} else {
				User user = new User(username, password);
				//添加用户
				userService.addUser(user);
				result = &#34;6&#34;;
			}
			out.print(result);
		} else if (type == 3) {	//用户退出
			request.getSession().invalidate();
		}
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		this.doGet(request, response);
	}

}
```

#### 4.4.8 创建图片控制器类 ImageAction

```
package com.shiyanlou.photo.action;

import java.io.IOException;
import java.util.Date;
import java.util.UUID;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;

import com.shiyanlou.photo.domain.Image;
import com.shiyanlou.photo.domain.User;
import com.shiyanlou.photo.service.ImageService;



/**
 * 图片控制器
 * @author www.shiyanlou.com
 *
 */
@WebServlet(value = &#34;/ImageAction&#34;)
@MultipartConfig
public class ImageAction extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		request.setCharacterEncoding(&#34;utf-8&#34;);
		response.setCharacterEncoding(&#34;utf-8&#34;);
		response.setContentType(&#34;text/html;charset=utf-8&#34;);
		Integer type = Integer.valueOf(request.getParameter(&#34;type&#34;));
		ImageService imageService = new ImageService();
		
		if (type == 1) {	//上传图片
			String imageName = request.getParameter(&#34;image_name&#34;);
			Part image = request.getPart(&#34;image&#34;);
			Image img = new Image();
			img.setDate(new Date());
			img.setName(imageName);
			img.setUser((User) request.getSession().getAttribute(&#34;user&#34;));
			img.setUrl(img.getUser().getUsername() + &#34;/&#34; + UUID.randomUUID());
			imageService.addImage(img, image.getInputStream());
			request.getSession().setAttribute(&#34;imageList&#34;, imageService.getByUserId(img.getUser().getId()));
			response.sendRedirect(request.getContextPath() + &#34;/home.jsp&#34;);
		} else if (type == 2) {	//删除图片
			String ids = request.getParameter(&#34;ids&#34;);
			String urls = request.getParameter(&#34;urls&#34;);
			imageService.delByIdsAndUrls(ids, urls);
			request.getSession().setAttribute(&#34;imageList&#34;, imageService.getByUserId(((User) request.getSession().getAttribute(&#34;user&#34;)).getId()));
		}
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		this.doGet(request, response);
	}

}
```

## 五、 发布

把 ShiyanlouPhoto 部署到 Tomcat 上，如图：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668874297.png/wm)


![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668898003.png/wm)

启动服务，点击 Start ，如图：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469668996793.png/wm)


启动服务器，访问 [http://localhost:8080/ShiyanlouPhoto/index.jsp](http://localhost:8080/ShiyanlouPhoto/index.jsp)

## 六、 项目运行

输入网址，进入登陆注册页面 index.jsp ,首先进行注册，如图：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469669402580.png/wm)

然后登陆：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469669455183.png/wm)

跳转至 home.jsp 页面，添加图片，选择右侧 Options ，点击 Upload ，如图：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469669641680.png/wm)

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469669706970.png/wm)

添加成功如下：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469669745832.png/wm)

选中图片，点击 Options ，选择 Delete 删除：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469669790422.png/wm)

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469669803847.png/wm)

删除成功。

注释：
运行项目时如果报错：

```
org.apache.jasper.JasperException: The absolute uri: http://java.sun.com/jsp/jstl/core cannot be 。
```

可以将与 jstl 有关的 jar 包拷贝到 tomcat 的 lib 文件夹下，即以下两个文件：

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid122889labid256timestamp1469685775979.png/wm)

## 七、 项目总结

本课程，在本地运行 JavaWeb 项目，通过七牛云平台，存储图片数据，有很强的实际意义。希望大家能够亲自动手编写，熟练掌握这种方法。
